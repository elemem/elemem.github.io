---
category: books-2016
published: true
layout: splash
title: 广告转码中心
description: the more you read, the more you think, better you'll be.
---

## 广告转码中心

---
[TOC]

## 1、整体架构
整体架构图
![arch_ADtranscode.dot.png-50.3kB][1]

## 2、硬件需求
调度服务器一台，xeon E5 or xeon E3。
编码服务器一台，xeon E3 or  core I7级别。
FTP存储中心一个，前期3T存储空间，需要监控磁盘使用情况，满80%后报警；具有后期扩容能力。FTP存储中心需要提供外网访问能力和内网访问能力。

## 3、调度中心

### 3.1、web
对外提供任务提交、任务查询、任务删除、任务修改功能。是调度系统与用户之间的代理人，以HTTP方式提供接口，接口格式参考通用REST API。

任务提交：
>输入：inputFile，编码模板枚举，outputfolder，优先级
功能：调用调度系统提供接口，建立任务
返回：任务ID，以及提交结果。

任务查询：
>输入：任务ID or 提交时间段 or 文件名（模糊匹配）
功能：调用调度系统提供接口，返回任务描述信息
返回：任务描述信息

任务删除：
>输入:任务ID
功能：调用调度系统提供接口，在任务列表删除未执行完毕的任务。如果删除已经完成的任务，需要提示是否清除历史记录以及编码结果。
返回：执行结果

任务修改：
>输入：任务ID，编码模板枚举
功能：调用调度系统提供接口，修改任务ID对应的编码请求描述
返回：执行结果

前期承担一定的业务逻辑；后期业务逻辑多了以后，将业务逻辑分离，在web和调度系统之间添加一个业务模块。

###3.2、调度系统
对web模块提供任务提交、任务查询、任务删除、任务修改4个接口。

####对外接口
任务提交：
>输入：编码请求描述，JSON或XML格式；提交者账号
功能：建立一个任务ID，添加时间信息，放入任务队列。
返回：任务ID，以及提交结果。

任务查询：
>输入：任务ID
功能：任务描述信息
返回：任务描述信息

任务删除：
>输入:任务ID
功能：在任务列表删除未执行完毕的任务。
返回：执行结果

任务修改：
>输入：任务ID,编码请求描述
功能：修改任务ID对应的编码请求描述
返回：执行结果

####内部逻辑
当任务列表有任务，并且有可用编码服务器时，会把任务提交给服务器转码。调度系统能够根据每个任务和集群列表中每个节点的特性，合理分配任务。任务完成或失败时，会将任务放入相应的队列。转码任务失败时，会将错误信息（包括编码日志）以邮件发送到某个邮件组。

###3.3、任务列表（T1~Tn）
任务列表中包含待转码以及转码中的任务列表，已经转码的任务会移动到历史记录中。
>任务属性：
ID
编码请求描述
状态（未开始、进行中、已完成、失败）
优先级

###3.4、集群代理列表（D1~Dn）
每个转码服务器在调度系统中的代理，编码系统通过它与具体的编码服务器做交互。
功能：
向编码服务器提交转码任务，返回：任务接受反馈。
接受转码服务器状态汇报。
接受转码任务执行进度更新。
接受转码任务执行结果，结果需要包含视频文件输出地址。

###3.5、历史记录
已完成任务会作永久记录，包含转码日志。数据记录必须包含足够信息，以便系统批量重新转码。每次转码都有一条历史纪录，因此一个任务可能有多个转码记录。
>任务属性：
ID
[
编码请求描述
状态（已完成、失败）
优先级
输出文件地址（如果失败可以为空）
日志文件
开始时间
结束时间
]

##4、编码集群（server 1~server n）
编码服务器集群，和集群代理列表做交互。
每一台编码服务器启动后，会主动和集群代理注册。注册后等待接受任务。
接受任务后，给予反馈。
>任务描述：
ID
编码请求描述

任务执行时，定时汇报进度。
任务结束后，会将日志上传给集群代理，并告知执行结果。任务成功后，会将结果上传到服务器。
>执行结果描述
ID
运行结果（成功or失败）
编码日志(直接传给集群代理，而不是告知FTP地址由集群代理去拉取)
编码结果文件


##5、数据存储
输入输出视频文件存放地址，日志存储位置。以FTP方式对外提供接口。对用户、编码集群提供访问权限。


  [1]: http://static.zybuluo.com/elemem/x1j3xo08ndelfjhsb9l4z2cg/arch_ADtranscode.dot.png